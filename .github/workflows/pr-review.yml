name: jobtaker
on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]
permissions:
  contents: read
  checks: write
  pull-requests: write
  id-token: write
jobs:
  jobtaker:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@jobtaker')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@jobtaker')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@jobtaker')) ||
      (contains(github.event.pull_request.labels.*.name, 'jobtaker')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@jobtaker') || contains(github.event.issue.title, '@jobtaker')))
    runs-on: ${{ vars.RUNNER }}
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - name: Validate ANTHROPIC_API_KEY
        shell: bash
        run: |
          if [ -z "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            exit 1
          fi
      - name: jobtaker
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          trigger_phrase: '@jobtaker'
          # settings: ${{ toJSON(fromJSON(needs.config.outputs.config).ai.settings) }}
          #            description: "Claude Code settings as JSON string or path to settings JSON file"
          allowed_bots: '*'
          #            description: "Comma-separated list of allowed bot usernames, or '*' to allow all bots. Empty string (default) allows no bots."
          # Your custom review instructions
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Provide detailed feedback using inline comments for ONLY issues, no praise inline comments.
            Use top-level comments for general observations or praise
            Do not be shy, I am a big boy and can handle criticism gracefully. I welcome feedback and suggestions.

            Review this PR against our team checklist:

            ## Code Quality
            - [ ] Code follows our style guide
            - [ ] No commented-out code
            - [ ] Meaningful variable names
            - [ ] DRY principle followed

            ## Testing
            - [ ] Unit tests for new functions
            - [ ] Integration tests for new endpoints
            - [ ] Edge cases covered
            - [ ] Test coverage > 80%

            ## Documentation
            - [ ] README updated if needed
            - [ ] API docs updated
            - [ ] Inline comments for complex logic
            - [ ] CHANGELOG.md updated

            ## Security
            - [ ] No hardcoded credentials
            - [ ] Input validation implemented
            - [ ] Proper error handling
            - [ ] No sensitive data in logs

            For each item, check if it is satisfied and comment on any that need attention.
            Post a summary comment with checklist results.
          # Tools for comprehensive PR review
          # claude_args: ${{ fromJSON(needs.config.outputs.config).ai.claude_args }}
          use_sticky_comment: false
          # description: "Use just one comment to deliver issue/PR comments"
          # required: false
          # default: "false"
          track_progress: true
          #            description: "Force tag mode with tracking comments for pull_request and issue events. Only applicable to pull_request (opened, synchronize, ready_for_review, reopened) and issue (opened, edited, labeled, assigned) events."
          path_to_claude_code_executable: ''
          #           description: "Optional path to a custom Claude Code executable. If provided, skips automatic installation and uses this executable instead. WARNING: Using an older version may cause problems if the action begins taking advantage of new Claude Code features. This input is typically not needed unless you're debugging something specific or have unique needs in your environment."
          path_to_bun_executable: ''
          #            description: "Optional path to a custom Bun executable. If provided, skips automatic Bun installation and uses this executable instead. WARNING: Using an incompatible version may cause problems if the action requires specific Bun features. This input is typically not needed unless you're debugging something specific or have unique needs in your environment."
          show_full_output: 'false'
          #            description: "Show full JSON output from Claude Code. WARNING: This outputs ALL Claude messages including tool execution results which may contain secrets, API keys, or other sensitive information. These logs are publicly visible in GitHub Actions. Only enable for debugging in non-sensitive environments."
          plugins: ''
          #           description: "Newline-separated list of Claude Code plugin names to install (e.g., 'code-review@claude-code-plugins\nfeature-dev@claude-code-plugins')"
          plugin_marketplaces: ''
#            description: "Newline-separated list of Claude Code plugin marketplace Git URLs to install from (e.g., 'https://github.com/user/marketplace1.git\nhttps://github.com/user/marketplace2.git')"

# When track_progress is enabled:
# - Creates a tracking comment with progress checkboxes
# - Includes all PR context (comments, attachments, images)
# - Updates progress as the review proceeds
# - Marks as completed when done
