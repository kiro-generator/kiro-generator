// KDL Agent Configuration Example
// 
// KDL (KDL Document Language) is a human-friendly document language with XML-like
// semantics that looks like you're invoking a bunch of CLI commands.
// Learn more at: https://kdl.dev/
//
// This file demonstrates agent configuration WITHOUT the wrapping `agent "name" { }`
// block. This format is used in individual agent files like:
//   ~/.kiro/generators/<agent-name>.kdl
//   .kiro/generators/<agent-name>.kdl
//
// The master config (kg.kdl) uses the full `agent "name" { }` syntax.

// ============================================================================
// BASIC METADATA
// ============================================================================

// Human-readable description of what this agent does
description "Example agent demonstrating all configuration options"

// Custom system prompt to guide agent behavior
prompt "You are a helpful assistant focused on code quality and best practices"

// Specify which LLM model to use (optional)
model "claude-3-5-sonnet"

// ============================================================================
// TOOLS & PERMISSIONS
// ============================================================================

// Define which tools the agent can use
// Use "*" for all tools, or list specific ones
tools "*"                    // Allow all tools
// tools "read" "write" "shell"  // Or specify individual tools

// Restrict which tools are actually allowed (subset of tools)
// Useful when tools="*" but you want to limit access
allowed-tools "read" "knowledge" "web_search" "@rustdocs" "@cargo"

// Tool aliases - rename tools for clarity or compatibility
alias "execute_bash" "shell"
alias "fs_read" "read"

// ============================================================================
// RESOURCES
// ============================================================================

// Files or directories to include as context for the agent
// Supports file:// URLs and glob patterns
resource "file://README.md"
resource "file://CONTRIBUTING.md"
resource "file://.amazonq/rules/**/*.md"

// ============================================================================
// MCP SERVERS (Model Context Protocol)
// ============================================================================

// Configure external MCP servers that provide additional tools
// Each server gets a unique name used with @ prefix in allowed-tools

mcp "rustdocs" {
    command "mcp-docsrs"              // Binary to execute
    timeout 1200                       // Timeout in milliseconds
}

mcp "cargo" {
    command "cargo-mcp"
    args "--debug" "--verbose"         // Command-line arguments
    timeout 120000
}

mcp "awsdocs" {
    command "aws-docs-mcp"
    args "--region" "us-east-1"
    env "RUST_LOG" "debug"             // Environment variables
    env "AWS_PROFILE" "default"
    header "Authorization" "Bearer token"  // HTTP headers for server
    timeout 5000
    oauth {                            // OAuth configuration
        redirect-uri "127.0.0.1:7778"
    }
}

// Include MCP server definitions in generated JSON
include-mcp-json true

// ============================================================================
// NATIVE TOOL PERMISSIONS
// ============================================================================

// Fine-grained control over built-in Kiro tools
// Each tool supports: allow, deny, override
// Patterns are regex-based

native-tool {
    // File read permissions
    read {
        allow "./src/*" "./scripts/**" "./docs/**"
        deny ".*secret.*" ".*\.env.*" ".*Cargo.lock.*"
    }

    // File write permissions  
    write {
        allow "./src/*" "./scripts/**"
        deny "Cargo.lock" "package-lock.json"
        override "/tmp/*"              // Force allow (ignores deny rules)
    }

    // Shell command permissions
    shell {
        // Multi-line format with backslash continuation
        allow "git status" "git fetch" "git diff .*" \
              "git pull .*" "cargo build" "cargo test" \
              "kubectl get .*" "aws s3 ls .*"

        deny "git push .*" "git commit .*" \
             "rm -rf .*" "kubectl delete .*" \
             "aws s3 rm .*" ".*destroy.*"

        override "git pull origin main"  // Force allow specific command
    }

    // Alternative: one-liner format with semicolons
    // read { allow "./src/*"; deny ".*secret.*"; }
    // write { allow "./src/*"; deny "Cargo.lock"; }

    // AWS CLI permissions (if using AWS tools)
    aws disable-auto-readonly=true {
        allow "s3:GetObject" "s3:ListBucket"
        deny "s3:DeleteObject" "ec2:TerminateInstances"
    }

    // Shell with deny-by-default mode
    // shell deny-by-default=true {
    //     allow "git status"
    //     allow "cargo check"
    // }
}

// ============================================================================
// HOOKS
// ============================================================================

// Execute commands at specific lifecycle events
// Useful for setup, validation, cleanup, or logging

hook {
    // Runs when agent is spawned/initialized
    agent-spawn "setup" {
        command "echo Agent initialized at $(date)"
        timeout-ms 5000
        max-output-size 10000          // Max bytes of output to capture
        cache-ttl-seconds 300          // Cache result for 5 minutes
    }

    // Runs when user submits a prompt
    user-prompt-submit "log-prompt" {
        command "echo User prompt received | tee -a /tmp/agent.log"
        timeout-ms 1000
    }

    // Runs before any tool is used
    pre-tool-use "validate" {
        command "echo About to use tool: $TOOL_NAME"
        matcher "git.*"                // Only run for git commands
        timeout-ms 2000
    }

    // Runs after any tool is used
    post-tool-use "audit" {
        command "echo Tool completed: $TOOL_NAME with status $EXIT_CODE"
        timeout-ms 2000
    }

    // Runs when agent stops/terminates
    stop "cleanup" {
        command "echo Agent stopped at $(date)"
        timeout-ms 3000
    }
}

// ============================================================================
// SYNTAX VARIATIONS
// ============================================================================

// KDL supports multiple formatting styles:

// 1. Multi-line with explicit children
// native-tool {
//     shell {
//         allow "git status"
//         deny "git push"
//     }
// }

// 2. One-liner with semicolons
// native-tool { shell { allow "git status"; deny "git push"; } }

// 3. Mixed style
// native-tool {
//     shell { allow "git status"; deny "git push"; }
//     read { allow "./src/*"; }
// }

// 4. Line continuation with backslash
// native-tool {
//     shell {
//         allow "git status" "git fetch" \
//               "git diff" "git log"
//     }
// }

// ============================================================================
// NOTES
// ============================================================================

// - Regex patterns: Use .* for wildcards, not shell globs
// - Override rules: Take precedence over allow/deny
// - Inheritance: Defined in kg.kdl, not in agent files
// - Templates: Marked with template=true in kg.kdl only
// - Tool names: Use @ prefix for MCP tools (@rustdocs, @cargo)
// - Paths: Relative to project root or absolute
// - Commands: Executed in shell, have access to env vars
